# PeMCP Docker Compose Configuration
#
# Usage:
#   HTTP mode (network/web access):
#     docker compose up pemcp-http
#
#   HTTP mode with a pre-loaded file:
#     docker compose run --rm pemcp-http --input-file /samples/malware.exe
#
#   stdio mode (for Claude Code / MCP clients):
#     docker compose run --rm -i pemcp-stdio
#
#   Build only:
#     docker compose build
#
# Environment:
#   Copy .env.example to .env and set your API keys there,
#   or export VT_API_KEY in your shell before running.
#
# Qiling rootfs:
#   To enable Windows PE emulation, copy DLLs from a Windows installation
#   into ./qiling-rootfs/x86_windows/Windows/System32/ (and x8664_windows
#   for 64-bit).  See docs/QILING_ROOTFS.md for detailed instructions.

services:
  pemcp-http:
    build: .
    image: pemcp-toolkit:latest
    ports:
      - "127.0.0.1:${PEMCP_PORT:-8082}:8082"
    volumes:
      - ./samples:/samples:ro
      - ${PEMCP_OUTPUT:-./output}:/output:rw
      - pemcp-data:/app/home/.pemcp
      - ${PEMCP_ROOTFS:-./qiling-rootfs}:/app/qiling-rootfs
    environment:
      - VT_API_KEY=${VT_API_KEY:-}
      - PEMCP_API_KEY=${PEMCP_API_KEY:-}
    command:
      - "--mcp-server"
      - "--mcp-transport"
      - "streamable-http"
      - "--mcp-host"
      - "0.0.0.0"
      - "--allowed-paths"
      - "/samples"
      - "/output"
      - "--samples-path"
      - "/samples"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: "4.0"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8082/mcp')"]
      interval: 30s
      timeout: 5s
      start_period: 60s
      retries: 3

  pemcp-stdio:
    build: .
    image: pemcp-toolkit:latest
    stdin_open: true
    volumes:
      - ./samples:/samples:ro
      - ${PEMCP_OUTPUT:-./output}:/output:rw
      - pemcp-data:/app/home/.pemcp
      - ${PEMCP_ROOTFS:-./qiling-rootfs}:/app/qiling-rootfs
    environment:
      - VT_API_KEY=${VT_API_KEY:-}
    command: ["--mcp-server", "--samples-path", "/samples"]
    profiles:
      - stdio

volumes:
  pemcp-data:
    name: pemcp-data
